name: Deploy Frontend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies & build
        run: |
          npm install
          npm run build

      - name: üîë Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: üõ°Ô∏è Add server to known_hosts
        run: echo "${{ secrets.SERVER_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: üöÄ Rsync frontend to server
        run: |
          rsync -avz --delete \
            --exclude 'node_modules/' \
            --exclude '.git/' \
            --exclude '.vscode/' \
            -e "ssh -o StrictHostKeyChecking=yes" \
            . \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/srv/sommelier_frontend/

      - name: üîÑ Restart frontend service
        run: |
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            sudo systemctl daemon-reload &&
            sudo systemctl restart sommelier_frontend.service
          "

      - name: ü©∫ Check frontend health
        run: |
          ssh -o StrictHostKeyChecking=yes ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            sleep 5 &&
            curl -I https://tusommeliervirtual.com || echo '‚ùå Frontend no respondi√≥'
          "
